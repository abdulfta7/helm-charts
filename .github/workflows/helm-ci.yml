name: Helm CI Pipeline

on:
  push:
    branches: [main]

jobs:
  lint-and-scan:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout the repo
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2️⃣ Install Helm
      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: v3.12.0

      # 3️⃣ Verify required files
      - name: Verify devops-app folder exists
        run: |
          if [ ! -d "devops-app" ]; then
            echo "Folder devops-app does not exist!"
            exit 1
          fi
          if [ ! -f "devops-app/Chart.yaml" ]; then
            echo "Chart.yaml missing!"
            exit 1
          fi
          echo "All required files exist ✅"

      # 4️⃣ Lint Helm chart
      - name: Helm Lint
        run: |
          helm lint devops-app

      # 5️⃣ Install kubeval
      - name: Install kubeval
        run: |
          sudo apt-get update
          sudo apt-get install -y kubeval

      # 6️⃣ Download Kubernetes schemas locally (avoids 404)
      - name: Download kubeval schemas
        run: |
          kubeval --download-schema

      # 7️⃣ Scan all YAML templates using local schemas
      - name: Scan Helm templates
        run: |
          for file in devops-app/templates/*.yaml; do
            echo "Scanning $file"
            kubeval --kubernetes-version=v1.26 "$file"
          done

      # 8️⃣ Package Helm chart
      - name: Package Helm chart
        run: |
          helm package devops-app
