name: Helm CI Pipeline

on:
  push:
    branches: [dev]

jobs:
  verify-and-lint:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout the repo
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2️⃣ Install Helm
      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: v3.12.0

      # 3️⃣ Verify required files and structure
      - name: Verify devops-app folder and files
        run: |
          echo "Verifying devops-app structure..."
          
          # Check if devops-app folder exists
          if [ ! -d "devops-app" ]; then
            echo "❌ Folder devops-app does not exist!"
            exit 1
          fi
          echo "✅ devops-app folder exists"
          
          # Check if Chart.yaml exists
          if [ ! -f "devops-app/Chart.yaml" ]; then
            echo "❌ Chart.yaml missing!"
            exit 1
          fi
          echo "✅ Chart.yaml exists"
          
          # Check if values.yaml exists
          if [ ! -f "devops-app/values.yaml" ]; then
            echo "❌ values.yaml missing!"
            exit 1
          fi
          echo "✅ values.yaml exists"
          
          # Check if templates directory exists
          if [ ! -d "devops-app/templates" ]; then
            echo "❌ templates directory missing!"
            exit 1
          fi
          echo "✅ templates directory exists"
          
          # Count YAML files in templates
          template_count=$(find devops-app/templates -type f -name "*.yaml" | wc -l)
          if [ $template_count -eq 0 ]; then
            echo "❌ No YAML templates found in templates directory!"
            exit 1
          fi
          echo "✅ Found $template_count template files"
          
          # Validate Chart.yaml structure
          if ! grep -q "^apiVersion:" devops-app/Chart.yaml; then
            echo "❌ Chart.yaml missing apiVersion!"
            exit 1
          fi
          echo "✅ Chart.yaml has valid structure"
          
          # Validate values.yaml is valid YAML
          if ! python3 -c "import yaml; yaml.safe_load(open('devops-app/values.yaml'))" 2>/dev/null; then
            echo "❌ values.yaml is not valid YAML!"
            exit 1
          fi
          echo "✅ values.yaml is valid YAML"
          
          echo ""
          echo "All verifications passed! ✅"

      # 4️⃣ Lint Helm chart
      - name: Helm Lint
        run: |
          helm lint devops-app

  scan-and-package:
    runs-on: ubuntu-latest
    needs: verify-and-lint

    steps:
      # 1️⃣ Checkout the repo
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2️⃣ Install Helm
      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: v3.12.0

      # 3️⃣ Install kubeval
      - name: Install kubeval
        run: |
          wget https://github.com/instrumenta/kubeval/releases/latest/download/kubeval-linux-amd64.tar.gz
          tar xf kubeval-linux-amd64.tar.gz
          sudo mv kubeval /usr/local/bin/

      # 4️⃣ Render and validate Helm templates
      - name: Scan Helm templates
        run: |
          helm template devops-app devops-app --output-dir /tmp/helm-output
          for file in /tmp/helm-output/devops-app/templates/*.yaml; do
            echo "Scanning $file"
            kubeval --kubernetes-version=v1.26 --ignore-missing-schemas "$file" || true
          done

      # 5️⃣ Package Helm chart
      - name: Package Helm chart
        run: |
          helm package devops-app
